<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zimax.mcrs.monitor.mapper.AccessMonitorMapper">
    <!--添加监控信息-->
    <insert id="addSoftwareRunStatus" parameterType="com.zimax.mcrs.monitor.pojo.SoftwareRunStatus">
        insert into mon_soft_status
        values (#{softwareRunId}, #{equipmentId}, #{APPId}, #{deviceName}, #{deviceSoType},
                #{deviceSoRunStatus}, #{cpuRate}, #{storageRate}, #{errorRate}, #{createTime})
    </insert>

    <insert id="addEquipmentStatus" parameterType="com.zimax.mcrs.monitor.pojo.EquipmentStatus">
        insert into mon_equipment_status
        values (#{equipmentStatusId}, #{equipmentId}, #{accessType}, #{accessStatus}, #{antennaStatus}, #{createTime})
    </insert>

    <insert id="addDeviceAbn" parameterType="com.zimax.mcrs.monitor.pojo.DeviceAbn">
        insert into mon_device_abn
        values (#{deviceAbnId}, #{equipmentId}, #{APPId}, #{deviceName}, #{useProcess}, #{warningTitle},#{warningType}, #{warningLevel}, #{warningContent}, #{occurTime}, #{remarks}, #{createTime})
    </insert>


    <select id="groupQueryBydate" resultType="com.zimax.mcrs.monitor.pojo.vo.GroupByDate">
        select date_format(t1.occur_time, '%Y-%m-%d')              as recordDate,
               sum(CASE warning_type WHEN "101" THEN 1 ELSE 0 END) AS "activeWarn",
               sum(CASE warning_type WHEN "100" THEN 1 ELSE 0 END) AS "hardWarn"
        from mon_device_abn t1
        group by date_format(t1.occur_time, '%Y-%m-%d')
        ORDER BY t1.occur_time desc limit 0,7
    </select>
    <!--    告警信息-->
    <select id="getWarnInfo" resultType="com.zimax.mcrs.monitor.pojo.vo.WarnTotalInfo">
        select count(*)                                            as "warnTotal",
               sum(CASE warning_type WHEN "101" THEN 1 ELSE 0 END) AS "activeWarn",
               sum(CASE warning_type WHEN "100" THEN 1 ELSE 0 END) AS "hardWarn"
        from mon_device_abn
    </select>

    <select id="getWarnByproduction" resultType="com.zimax.mcrs.monitor.pojo.vo.GroupByProduction">
        select b.process_name name ,count(b.process_name) value
        from mon_device_abn a
                 left JOIN base_process_info b on a.use_process=b.process_id
        group by b.process_name
    </select>

    <select id="getEqiOnline" resultType="Int">
        select count(*) as eqiOnline
        from mon_soft_status
        where device_so_run_status = "101"
    </select>

    <select id="getAccessOnline" resultType="Int">
        select count(*) as accessOnline
        from mon_equipment_status
        where access_status = "101"
    </select>

    <select id="queryProcessAndeqi" resultType="com.zimax.mcrs.monitor.pojo.vo.GroupByProduction">
        SELECT bpi.process_name name,count(bpi.process_name) value
        FROM eqi_equipment AS eqi
                 LEFT JOIN base_access_info AS bai ON eqi.acc_point_res_id = bai.acc_point_res_id
                 LEFT JOIN base_process_info AS bpi
                           ON bai.process_id = bpi.process_id
        group by bpi.process_name

    </select>
<!--工厂对应工序的设备数量-->
    <select id="queryFactoryId" resultType="int">
        SELECT bfi.factory_id
        FROM eqi_equipment AS eqi
                 LEFT JOIN base_access_info AS bai ON eqi.acc_point_res_id = bai.acc_point_res_id
                 LEFT JOIN base_process_info AS bpi
                           ON bai.process_id = bpi.process_id
                 LEFT JOIN base_factory_info AS bfi
                           ON bpi.factory_id = bfi.factory_id
        group by bfi.factory_id
    </select>

    <select id="queryProcessName" resultType="String">
        SELECT bpi.process_name processName
        FROM eqi_equipment AS eqi
                 LEFT JOIN base_access_info AS bai ON eqi.acc_point_res_id = bai.acc_point_res_id
                 LEFT JOIN base_process_info AS bpi
                           ON bai.process_id = bpi.process_id
        group by bpi.process_name
    </select>
    <select id="queryFactoryAndProcess" resultType="com.zimax.mcrs.monitor.pojo.vo.ProcessOnfactory">
        SELECT bfi.factory_id,bfi.factory_name,bpi.process_name processName,count(bpi.process_id) as total,bpi.process_id
        FROM eqi_equipment AS eqi
                 LEFT JOIN base_access_info AS bai ON eqi.acc_point_res_id = bai.acc_point_res_id
                 LEFT JOIN base_process_info AS bpi
                           ON bai.process_id = bpi.process_id
                 LEFT JOIN base_factory_info AS bfi
                           ON bpi.factory_id = bfi.factory_id
        group by bpi.process_id
    </select>

</mapper>





